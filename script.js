class MyTuneBox {
      constructor() {
          this.audio = new Audio();
              this.tracks = [];
                  this.currentIndex = -1;
                      this.isPlaying = false;
                          this.isMuted = false;
                              this.volume = 0.8;
                                  this.loopMode = 'none'; // 'none', 'one', 'all'
                                      this.isShuffle = false;
                                          this.shuffleOrder = [];

                                              this.initElements();
                                                  this.bindEvents();
                                                      this.setupAudioEvents();
                                                          this.loadFromStorage();
                                                              this.updateTheme();
                                                                }

                                                                  initElements() {
                                                                      // DOM 元素
                                                                          this.fileInput = document.getElementById('fileInput');
                                                                              this.dropZone = document.getElementById('dropZone');
                                                                                  this.playlistEl = document.getElementById('playlist');
                                                                                      this.trackCountEl = document.getElementById('trackCount');
                                                                                          this.albumArtEl = document.getElementById('albumArt');
                                                                                              this.trackTitleEl = document.getElementById('trackTitle');
                                                                                                  this.trackArtistEl = document.getElementById('trackArtist');
                                                                                                      this.currentTimeEl = document.getElementById('currentTime');
                                                                                                          this.durationEl = document.getElementById('duration');
                                                                                                              this.progressBar = document.getElementById('progressBar');
                                                                                                                  this.progressFill = document.getElementById('progressFill');
                                                                                                                      this.playBtn = document.getElementById('playBtn');
                                                                                                                          this.prevBtn = document.getElementById('prevBtn');
                                                                                                                              this.nextBtn = document.getElementById('nextBtn');
                                                                                                                                  this.muteBtn = document.getElementById('muteBtn');
                                                                                                                                      this.volumeSlider = document.getElementById('volumeSlider');
                                                                                                                                          this.loopBtn = document.getElementById('loopBtn');
                                                                                                                                              this.shuffleBtn = document.getElementById('shuffleBtn');
                                                                                                                                                  this.themeToggle = document.getElementById('themeToggle');
                                                                                                                                                      this.clearAllBtn = document.getElementById('clearAllBtn');
                                                                                                                                                          this.toastEl = document.getElementById('toast');

                                                                                                                                                              // 设置初始音量
                                                                                                                                                                  this.audio.volume = this.volume;
                                                                                                                                                                      this.volumeSlider.value = this.volume;
                                                                                                                                                                        }

                                                                                                                                                                          bindEvents() {
                                                                                                                                                                              // 文件选择
                                                                                                                                                                                  this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                                                                                                                                                                                      
                                                                                                                                                                                          // 拖拽上传
                                                                                                                                                                                              this.dropZone.addEventListener('dragover', (e) => {
                                                                                                                                                                                                    e.preventDefault();
                                                                                                                                                                                                          this.dropZone.style.borderColor = '#4f46e5';
                                                                                                                                                                                                              });
                                                                                                                                                                                                                  this.dropZone.addEventListener('dragleave', () => {
                                                                                                                                                                                                                        this.dropZone.style.borderColor = '';
                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                this.dropZone.addEventListener('drop', (e) => {
                                                                                                                                                                                                                                      e.preventDefault();
                                                                                                                                                                                                                                            this.dropZone.style.borderColor = '';
                                                                                                                                                                                                                                                  if (e.dataTransfer.files.length) {
                                                                                                                                                                                                                                                          this.handleFiles(Array.from(e.dataTransfer.files));
                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                    });

                                                                                                                                                                                                                                                                        // 播放控制
                                                                                                                                                                                                                                                                            this.playBtn.addEventListener('click', () => this.togglePlayPause());
                                                                                                                                                                                                                                                                                this.prevBtn.addEventListener('click', () => this.playPrevious());
                                                                                                                                                                                                                                                                                    this.nextBtn.addEventListener('click', () => this.playNext());

                                                                                                                                                                                                                                                                                        // 进度条
                                                                                                                                                                                                                                                                                            this.progressBar.addEventListener('click', (e) => this.seek(e));

                                                                                                                                                                                                                                                                                                // 音量控制
                                                                                                                                                                                                                                                                                                    this.muteBtn.addEventListener('click', () => this.toggleMute());
                                                                                                                                                                                                                                                                                                        this.volumeSlider.addEventListener('input', (e) => this.setVolume(e.target.value));

                                                                                                                                                                                                                                                                                                            // 播放模式
                                                                                                                                                                                                                                                                                                                this.loopBtn.addEventListener('click', () => this.toggleLoop());
                                                                                                                                                                                                                                                                                                                    this.shuffleBtn.addEventListener('click', () => this.toggleShuffle());

                                                                                                                                                                                                                                                                                                                        // 主题切换
                                                                                                                                                                                                                                                                                                                            this.themeToggle.addEventListener('click', () => this.toggleTheme());

                                                                                                                                                                                                                                                                                                                                // 清空播放列表
                                                                                                                                                                                                                                                                                                                                    this.clearAllBtn.addEventListener('click', () => this.clearAll());

                                                                                                                                                                                                                                                                                                                                        // 键盘快捷键
                                                                                                                                                                                                                                                                                                                                            document.addEventListener('keydown', (e) => this.handleKeyboard(e));

                                                                                                                                                                                                                                                                                                                                                // 页面卸载时清理资源
                                                                                                                                                                                                                                                                                                                                                    window.addEventListener('beforeunload', () => this.cleanup());
                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                        setupAudioEvents() {
                                                                                                                                                                                                                                                                                                                                                            this.audio.addEventListener('loadedmetadata', () => this.onLoadedMetadata());
                                                                                                                                                                                                                                                                                                                                                                this.audio.addEventListener('timeupdate', () => this.onTimeUpdate());
                                                                                                                                                                                                                                                                                                                                                                    this.audio.addEventListener('ended', () => this.onEnded());
                                                                                                                                                                                                                                                                                                                                                                        this.audio.addEventListener('error', (e) => this.onError(e));
                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                            handleFileSelect(event) {
                                                                                                                                                                                                                                                                                                                                                                                const files = Array.from(event.target.files);
                                                                                                                                                                                                                                                                                                                                                                                    this.handleFiles(files);
                                                                                                                                                                                                                                                                                                                                                                                        event.target.value = ''; // 重置 input
                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                            handleFiles(files) {
                                                                                                                                                                                                                                                                                                                                                                                                const audioFiles = files.filter(file => file.type.startsWith('audio/'));
                                                                                                                                                                                                                                                                                                                                                                                                    if (audioFiles.length === 0) {
                                                                                                                                                                                                                                                                                                                                                                                                          this.showToast('请选择音频文件！');
                                                                                                                                                                                                                                                                                                                                                                                                                return;
                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                        audioFiles.forEach(file => {
                                                                                                                                                                                                                                                                                                                                                                                                                              const track = {
                                                                                                                                                                                                                                                                                                                                                                                                                                      id: Date.now() + Math.random(),
                                                                                                                                                                                                                                                                                                                                                                                                                                              file: file,
                                                                                                                                                                                                                                                                                                                                                                                                                                                      url: URL.createObjectURL(file),
                                                                                                                                                                                                                                                                                                                                                                                                                                                              name: this.getFileNameWithoutExt(file.name),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      duration: 0,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              formattedDuration: '--:--'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          this.tracks.push(track);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                this.addTrackToDOM(track);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        this.updateTrackCount();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            this.saveToStorage();

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // 如果是第一首歌，自动播放
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (this.tracks.length === audioFiles.length && this.currentIndex === -1) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          this.playTrack(0);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  this.showToast(`成功添加 ${audioFiles.length} 首歌曲！`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      addTrackToDOM(track) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const li = document.createElement('li');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              li.dataset.id = track.id;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  li.innerHTML = `
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <span class="title">${this.escapeHtml(track.name)}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <span class="duration">${track.formattedDuration}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  `;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      li.addEventListener('click', () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const index = this.tracks.findIndex(t => t.id === track.id);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if (index !== -1) this.playTrack(index);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          this.playlistEl.appendChild(li);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              playTrack(index) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if (index < 0 || index >= this.tracks.length) return;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      this.currentIndex = index;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const track = this.tracks[index];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // 更新音频源
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      this.audio.src = track.url;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          this.audio.load();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // 更新UI
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      this.updateTrackInfo(track);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          this.setActiveTrack(index);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // 播放
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      this.audio.play().then(() => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            this.isPlaying = true;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  this.updatePlayButton();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }).catch(err => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            console.error('播放失败:', err);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  this.showToast('播放失败，请检查文件格式');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          togglePlayPause() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if (this.tracks.length === 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    this.showToast('请先添加歌曲！');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if (this.currentIndex === -1) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        this.playTrack(0);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if (this.isPlaying) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            this.audio.pause();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  this.isPlaying = false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            this.audio.play().then(() => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    this.isPlaying = true;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }).catch(err => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  console.error('播放失败:', err);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          this.showToast('播放失败');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        this.updatePlayButton();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            playPrevious() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (this.tracks.length === 0) return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        let newIndex;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (this.isShuffle && this.shuffleOrder.length > 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const currentIndexInShuffle = this.shuffleOrder.indexOf(this.currentIndex);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (currentIndexInShuffle > 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                newIndex = this.shuffleOrder[currentIndexInShuffle - 1];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              newIndex = this.shuffleOrder[this.shuffleOrder.length - 1];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              newIndex = this.currentIndex - 1;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (newIndex < 0) newIndex = this.tracks.length - 1;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                this.playTrack(newIndex);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    playNext() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (this.tracks.length === 0) return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                let newIndex;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (this.loopMode === 'one') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          newIndex = this.currentIndex;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              } else if (this.isShuffle && this.shuffleOrder.length > 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const currentIndexInShuffle = this.shuffleOrder.indexOf(this.currentIndex);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (currentIndexInShuffle < this.shuffleOrder.length - 1) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  newIndex = this.shuffleOrder[currentIndexInShuffle + 1];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                this.generateShuffleOrder();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        newIndex = this.shuffleOrder[0];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        newIndex = this.currentIndex + 1;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if (newIndex >= this.tracks.length) newIndex = 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          this.playTrack(newIndex);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              onLoadedMetadata() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const track = this.tracks[this.currentIndex];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if (!track) return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              track.duration = this.audio.duration;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  track.formattedDuration = this.formatTime(this.audio.duration);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // 更新播放列表中的时长
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const playlistItems = this.playlistEl.querySelectorAll('li');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if (playlistItems[this.currentIndex]) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        playlistItems[this.currentIndex].querySelector('.duration').textContent = track.formattedDuration;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    this.durationEl.textContent = track.formattedDuration;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        onTimeUpdate() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const currentTime = this.audio.currentTime;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                this.currentTimeEl.textContent = this.formatTime(currentTime);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const progress = (currentTime / (this.audio.duration || 1)) * 100;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            this.progressFill.style.width = `${progress}%`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                onEnded() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (this.loopMode === 'one') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          this.audio.currentTime = 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                this.audio.play();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          this.playNext();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  onError(error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      console.error('音频错误:', error);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          this.showToast('音频加载错误');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              this.isPlaying = false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  this.updatePlayButton();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      seek(event) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const rect = this.progressBar.getBoundingClientRect();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const clickX = event.clientX - rect.left;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const percentage = clickX / rect.width;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      this.audio.currentTime = percentage * this.audio.duration;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          setVolume(volume) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              this.volume = parseFloat(volume);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  this.audio.volume = this.volume;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      this.isMuted = this.volume === 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          this.updateMuteButton();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              toggleMute() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if (this.isMuted) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        this.audio.volume = this.volume;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              this.isMuted = false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        this.audio.volume = 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              this.isMuted = true;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      this.updateMuteButton();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          updateMuteButton() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const icon = this.muteBtn.querySelector('i');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if (this.isMuted) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        icon.className = 'fas fa-volume-mute';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            } else if (this.volume < 0.3) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  icon.className = 'fas fa-volume-off';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      } else if (this.volume < 0.7) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            icon.className = 'fas fa-volume-down';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      icon.className = 'fas fa-volume-up';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              toggleLoop() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const modes = ['none', 'one', 'all'];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const currentIndex = modes.indexOf(this.loopMode);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          this.loopMode = modes[(currentIndex + 1) % modes.length];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  this.loopBtn.classList.toggle('active', this.loopMode !== 'none');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      this.loopBtn.title = this.getLoopModeText();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              // 更新图标
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const icon = this.loopBtn.querySelector('i');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if (this.loopMode === 'none') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            icon.className = 'fas fa-redo';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                } else if (this.loopMode === 'one') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      icon.class
}